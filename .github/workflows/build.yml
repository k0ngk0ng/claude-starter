name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node.js version to bundle'
        required: false
        default: '20.18.1'
      git_version:
        description: 'Git for Windows version to bundle'
        required: false
        default: '2.47.1'

env:
  NODE_VERSION: ${{ github.event.inputs.node_version || '20.18.1' }}
  GIT_VERSION: ${{ github.event.inputs.git_version || '2.47.1' }}

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create directories
        run: |
          New-Item -ItemType Directory -Force -Path "deps/nodejs"
          New-Item -ItemType Directory -Force -Path "deps/git"
          New-Item -ItemType Directory -Force -Path "dist"
        shell: pwsh

      - name: Download Node.js
        run: |
          Write-Host "Downloading Node.js v$env:NODE_VERSION..."
          $nodeUrl = "https://nodejs.org/dist/v$env:NODE_VERSION/node-v$env:NODE_VERSION-win-x64.zip"
          Invoke-WebRequest -Uri $nodeUrl -OutFile "node.zip" -UseBasicParsing
          Expand-Archive -Path "node.zip" -DestinationPath "temp" -Force
          Move-Item -Path "temp/node-v$env:NODE_VERSION-win-x64/*" -Destination "deps/nodejs/" -Force
          Remove-Item -Path "temp" -Recurse -Force
          Remove-Item -Path "node.zip" -Force
        shell: pwsh

      - name: Download Git for Windows
        run: |
          Write-Host "Downloading Git for Windows v$env:GIT_VERSION..."
          $gitUrl = "https://github.com/git-for-windows/git/releases/download/v$env:GIT_VERSION.windows.1/PortableGit-$env:GIT_VERSION-64-bit.7z.exe"
          Invoke-WebRequest -Uri $gitUrl -OutFile "PortableGit.7z.exe" -UseBasicParsing
          Write-Host "Extracting Git..."
          Start-Process -FilePath ".\PortableGit.7z.exe" -ArgumentList "-o`"deps/git`" -y" -Wait -NoNewWindow
          Remove-Item -Path "PortableGit.7z.exe" -Force
        shell: pwsh

      - name: Pre-install Claude Code
        run: |
          Write-Host "Pre-installing Claude Code..."
          $env:PATH = "$PWD\deps\nodejs;$env:PATH"

          # Set npm prefix to local nodejs folder so everything is self-contained
          $env:npm_config_prefix = "$PWD\deps\nodejs"

          # Use npm mirror for faster download
          npm config set registry https://registry.npmmirror.com

          npm install -g @anthropic-ai/claude-code

          # Verify installation
          Write-Host "Installed packages:"
          Get-ChildItem "$PWD\deps\nodejs\node_modules" -Directory | Select-Object Name
          Write-Host "Bin files:"
          Get-ChildItem "$PWD\deps\nodejs" -Filter "claude*" | Select-Object Name
        shell: pwsh

      - name: Compress dependencies for faster installation
        run: |
          Write-Host "Compressing Node.js..."
          7z a -t7z -mx=5 -mmt=on "deps/nodejs.7z" "./deps/nodejs/*" | Out-Null

          Write-Host "Compressing Git..."
          7z a -t7z -mx=5 -mmt=on "deps/git.7z" "./deps/git/*" | Out-Null

          # Remove original folders to reduce installer size
          Remove-Item -Path "deps/nodejs" -Recurse -Force
          Remove-Item -Path "deps/git" -Recurse -Force

          Write-Host "Compression complete"
          Get-ChildItem deps/*.7z | ForEach-Object { Write-Host "$($_.Name): $([math]::Round($_.Length/1MB, 2)) MB" }
        shell: pwsh

      - name: Download 7za.exe for installer
        run: |
          # Download 7-Zip standalone executable
          $url = "https://www.7-zip.org/a/7za920.zip"
          Invoke-WebRequest -Uri $url -OutFile "7za.zip" -UseBasicParsing
          Expand-Archive -Path "7za.zip" -DestinationPath "7za_temp" -Force
          Copy-Item -Path "7za_temp/7za.exe" -Destination "windows/installer/resources/7za.exe"
          Remove-Item -Path "7za.zip" -Force
          Remove-Item -Path "7za_temp" -Recurse -Force
        shell: pwsh

      - name: Install NSIS
        run: |
          choco install nsis -y
        shell: pwsh

      - name: Create resource files
        run: |
          # Create LICENSE.txt
          @"
          Claude Code Windows Installer
          ==============================

          This installer bundles:
          - Claude Code CLI by Anthropic
          - Node.js (https://nodejs.org)
          - Git for Windows (https://gitforwindows.org)

          By installing this software, you agree to:

          1. Anthropic's Terms of Service (https://www.anthropic.com/terms)
          2. Node.js License (https://github.com/nodejs/node/blob/main/LICENSE)
          3. Git License (https://github.com/git/git/blob/master/COPYING)

          This installer is provided "as is" without warranty of any kind.
          "@ | Out-File -FilePath "windows/installer/resources/LICENSE.txt" -Encoding UTF8

          # Create README.txt
          @"
          Claude Code for Windows
          =======================

          Thank you for installing Claude Code!

          Getting Started:
          1. Launch "Claude Code" from your Desktop or Start Menu
          2. Configure your ANTHROPIC_API_KEY in the launcher
          3. Click "Launch Claude Code" to start

          Configuration:
          - All settings are saved in: %APPDATA%\ClaudeCode\config.json

          Bundled Components:
          - Node.js v$env:NODE_VERSION
          - Git v$env:GIT_VERSION
          - Claude Code CLI (latest)

          For more information, visit: https://claude.ai

          Support: https://github.com/anthropics/claude-code
          "@ | Out-File -FilePath "windows/installer/resources/README.txt" -Encoding UTF8
        shell: pwsh

      - name: Create placeholder images
        run: |
          Add-Type -AssemblyName System.Drawing

          # Create header.bmp (150x57 pixels for NSIS header)
          $headerBmp = New-Object System.Drawing.Bitmap(150, 57)
          $graphics = [System.Drawing.Graphics]::FromImage($headerBmp)
          $graphics.Clear([System.Drawing.Color]::FromArgb(45, 45, 45))
          $font = New-Object System.Drawing.Font("Segoe UI", 12, [System.Drawing.FontStyle]::Bold)
          $brush = New-Object System.Drawing.SolidBrush([System.Drawing.Color]::FromArgb(255, 149, 0))
          $graphics.DrawString("Claude Code", $font, $brush, 10, 18)
          $headerBmp.Save("windows/installer/resources/header.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          $graphics.Dispose()
          $headerBmp.Dispose()

          # Create welcome.bmp (164x314 pixels for NSIS welcome page)
          $welcomeBmp = New-Object System.Drawing.Bitmap(164, 314)
          $graphics = [System.Drawing.Graphics]::FromImage($welcomeBmp)
          $graphics.Clear([System.Drawing.Color]::FromArgb(30, 30, 30))
          $font = New-Object System.Drawing.Font("Segoe UI", 14, [System.Drawing.FontStyle]::Bold)
          $brush = New-Object System.Drawing.SolidBrush([System.Drawing.Color]::FromArgb(255, 149, 0))
          $graphics.TranslateTransform(82, 157)
          $graphics.RotateTransform(-90)
          $graphics.DrawString("Claude Code", $font, $brush, -50, -10)
          $welcomeBmp.Save("windows/installer/resources/welcome.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          $graphics.Dispose()
          $welcomeBmp.Dispose()

          # Icon is already in the repo at windows/installer/resources/claude.ico
          Write-Host "Using official Claude icon from repo"
        shell: pwsh

      - name: Create launcher batch file
        run: |
          @"
          @echo off
          powershell -ExecutionPolicy Bypass -File "%~dp0launcher\ClaudeCodeLauncher.ps1"
          "@ | Out-File -FilePath "windows/installer/resources/ClaudeCodeLauncher.bat" -Encoding ASCII
        shell: pwsh

      - name: Get version from tag
        id: version
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/(.+)') {
            $version = $matches[1]
          } else {
            $version = "dev"
          }
          Write-Host "Version: $version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Build NSIS installer
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          cd windows/installer/nsis

          # Pass version to NSIS
          & "C:\Program Files (x86)\NSIS\makensis.exe" /V4 /DPRODUCT_VERSION="$version" installer.nsi

          # Rename output file to include version
          $distPath = "..\..\..\dist"
          if (Test-Path "$distPath\ClaudeCodeSetup.exe") {
            Rename-Item "$distPath\ClaudeCodeSetup.exe" "ClaudeCodeSetup-$version.exe"
          }

          Write-Host "Built installer:"
          Get-ChildItem "$distPath" | ForEach-Object { Write-Host $_.Name }
        shell: pwsh

      - name: Package launcher update
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          # Create launcher update package
          New-Item -ItemType Directory -Force -Path "dist/launcher-update"

          # Copy launcher files
          Copy-Item "windows/launcher/ClaudeCodeLauncher.ps1" "dist/launcher-update/"
          Copy-Item "windows/installer/resources/claude.ico" "dist/launcher-update/"
          Copy-Item "windows/installer/resources/ClaudeCodeLauncher.vbs" "dist/launcher-update/"
          Copy-Item "windows/installer/resources/LaunchClaude.bat" "dist/launcher-update/"

          # Create README for launcher update
          $readme = "Claude Code Launcher Update $version`n"
          $readme += "=====================================`n`n"
          $readme += "To update the launcher, copy these files to your Claude Code installation:`n`n"
          $readme += "1. Copy ClaudeCodeLauncher.ps1 to: %PROGRAMFILES%\ClaudeCode\launcher\`n"
          $readme += "2. Copy claude.ico to: %PROGRAMFILES%\ClaudeCode\launcher\`n"
          $readme += "3. Copy ClaudeCodeLauncher.vbs to: %PROGRAMFILES%\ClaudeCode\`n"
          $readme += "4. Copy LaunchClaude.bat to: %PROGRAMFILES%\ClaudeCode\`n"
          $readme | Out-File -FilePath "dist/launcher-update/README.txt" -Encoding UTF8

          # Create zip
          Compress-Archive -Path "dist/launcher-update/*" -DestinationPath "dist/ClaudeCodeLauncher-$version.zip"

          Write-Host "Created launcher update package:"
          Get-ChildItem "dist/*.zip" | ForEach-Object { Write-Host "$($_.Name): $([math]::Round($_.Length/1KB, 2)) KB" }
        shell: pwsh

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ClaudeCodeSetup-${{ steps.version.outputs.VERSION }}
          path: dist/ClaudeCodeSetup-*.exe
          retention-days: 30

      - name: Upload launcher update artifact
        uses: actions/upload-artifact@v4
        with:
          name: ClaudeCodeLauncher-${{ steps.version.outputs.VERSION }}
          path: dist/ClaudeCodeLauncher-*.zip
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/ClaudeCodeSetup-*.exe
            dist/ClaudeCodeLauncher-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
